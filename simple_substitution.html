<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>単一換字式暗号 解読体験</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 2rem 0;
        }
        .container {
            background-color: #fff;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
        }
        h1, h2 {
            text-align: center;
            color: #1c1e21;
            border-bottom: 2px solid #f0f2f5;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .section {
            margin-bottom: 2.5rem;
        }
        .text-box {
            background-color: #f7f7f7;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 1rem;
            min-height: 100px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "Menlo", "Consolas", monospace;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        #decrypted-text .unmapped {
            color: #e0e0e0;
            font-weight: bold;
        }
        .freq-chart-container {
            display: flex;
            justify-content: flex-start;
            align-items: flex-end;
            height: 200px;
            border-bottom: 2px solid #ccc;
            padding: 0 5px;
            gap: 2px;
        }
        .bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
            text-align: center;
        }
        .bar {
            width: 80%;
            background-color: #4CAF50;
            border-radius: 3px 3px 0 0;
            transition: background-color 0.2s;
        }
        .bar:hover {
            background-color: #45a049;
        }
        #plaintext-freq-chart .bar {
            background-color: #6c757d;
        }
        #plaintext-freq-chart .bar:hover {
            background-color: #5a6268;
        }
        .bar-label {
            margin-top: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .decryption-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .decryption-header label {
            margin-bottom: 0;
            font-weight: 600;
        }
        #hint-button, #hint2-button {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #hint-button {
            background-color: #4CAF50;
        }
        #hint-button:hover {
            background-color: #45a049;
        }
        #hint2-button {
            background-color: #6c757d;
            margin-left: 10px;
        }
        #hint2-button:hover {
            background-color: #5a6268;
        }
        #hint-button:disabled, #hint2-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #key-map-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 10px;
        }
        .key-entry {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f7f7f7;
            border-radius: 6px;
            padding: 8px;
        }
        .key-entry label {
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 4px;
        }
        .key-entry input {
            width: 30px;
            height: 30px;
            text-align: center;
            font-size: 1.2rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-transform: uppercase;
        }
        .suggestion-container {
            margin-top: 3rem;
            text-align: center;
        }
        #suggestion-form {
            display: none;
            margin-top: 1rem;
        }
        #suggestion-text {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
            margin-bottom: 1rem;
            resize: vertical;
        }
        #submit-suggestion {
            padding: 0.6rem 1.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>単一換字式暗号 解読体験</h1>
    <!-- Sections from before -->
    <div class="section">
        <h2>暗号文</h2>
        <div id="ciphertext" class="text-box"></div>
    </div>
    <div class="section">
        <h2>アルファベット出現頻度 (頻度順)</h2>
        <div id="freq-chart" class="freq-chart-container"></div>
    </div>
    <div class="section" id="plaintext-freq-section" style="display: none;">
        <h2>平文アルファベット出現頻度 (頻度順)</h2>
        <div id="plaintext-freq-chart" class="freq-chart-container"></div>
    </div>
    <div class="section">
        <h2>解読</h2>
        <div class="decryption-header">
            <label>換字マップ (Ciphertext → Plaintext)</label>
            <div>
                <button id="hint-button">ヒント</button>
                <button id="hint2-button">ヒント2</button>
            </div>
        </div>
        <div id="key-map-grid"></div>
    </div>
    <div class="section">
        <h2>復号文</h2>
        <div id="decrypted-text" class="text-box"></div>
    </div>

    <!-- Suggestion Box Section -->
    <div class="suggestion-container">
        <button id="show-suggestion-box">改善提案</button>
        <div id="suggestion-form">
            <textarea id="suggestion-text" placeholder="このツールをより良くするためのアイデアを自由にお書きください。"></textarea>
            <button id="submit-suggestion">送信</button>
        </div>
        <p id="suggestion-thanks" style="display: none; color: green; font-weight: bold;">ご提案ありがとうございます！</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const PLAINTEXT = "CRYPTOGRAPHY IS THE PRACTICE AND STUDY OF TECHNIQUES FOR SECURE COMMUNICATION IN THE PRESENCE OF THIRD PARTIES CALLED ADVERSARIES. MORE GENERALLY, IT IS ABOUT CONSTRUCTING AND ANALYZING PROTOCOLS THAT PREVENT THIRD PARTIES OR THE PUBLIC FROM READING PRIVATE MESSAGES. MODERN CRYPTOGRAPHY EXISTS AT THE INTERSECTION OF THE DISCIPLINES OF MATHEMATICS, COMPUTER SCIENCE, ELECTRICAL ENGINEERING, COMMUNICATION SCIENCE, AND PHYSICS.";
    const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let secretKey = {}, reverseSecretKey = {}, userKey = {}, inputs = {};

    const ciphertextDiv = document.getElementById('ciphertext');
    const freqChartDiv = document.getElementById('freq-chart');
    const keyMapGridDiv = document.getElementById('key-map-grid');
    const decryptedTextDiv = document.getElementById('decrypted-text');
    const hintButton = document.getElementById('hint-button');
    const hint2Button = document.getElementById('hint2-button');
    const plaintextFreqSection = document.getElementById('plaintext-freq-section');
    const showSuggestionBtn = document.getElementById('show-suggestion-box');
    const suggestionForm = document.getElementById('suggestion-form');
    const suggestionText = document.getElementById('suggestion-text');
    const submitSuggestionBtn = document.getElementById('submit-suggestion');
    const suggestionThanks = document.getElementById('suggestion-thanks');

    function initialize() {
        generateKeys();
        const ciphertext = applyKey(PLAINTEXT, secretKey);
        ciphertextDiv.textContent = ciphertext;
        const frequencies = calculateFrequencies(ciphertext);
        drawFrequencyChart(frequencies, freqChartDiv, true);
        const sortedByFreq = Object.entries(frequencies).sort((a, b) => b[1] - a[1]);
        createKeyMapGrid();
        updateDecryption();
        hintButton.addEventListener('click', () => giveHint(sortedByFreq));
        hint2Button.addEventListener('click', showPlaintextFreq);
        showSuggestionBtn.addEventListener('click', () => {
            suggestionForm.style.display = 'block';
            showSuggestionBtn.style.display = 'none';
        });
        submitSuggestionBtn.addEventListener('click', () => {
            const suggestion = suggestionText.value;
            if (suggestion) {
                console.log("--- 改善提案 ---");
                console.log(suggestion);
                suggestionText.value = '';
                suggestionForm.style.display = 'none';
                suggestionThanks.style.display = 'block';
                setTimeout(() => {
                    suggestionThanks.style.display = 'none';
                    showSuggestionBtn.style.display = 'inline-block';
                }, 3000);
            }
        });
    }

    function generateKeys() {
        const shuffledAlphabet = ALPHABET.split('').sort(() => Math.random() - 0.5);
        ALPHABET.split('').forEach((char, index) => {
            const mappedChar = shuffledAlphabet[index];
            secretKey[char] = mappedChar;
            reverseSecretKey[mappedChar] = char;
        });
    }

    function applyKey(text, key) {
        return text.split('').map(char => key[char] || char).join('');
    }

    function calculateFrequencies(text) {
        const frequencies = {};
        for (const char of text) {
            if (ALPHABET.includes(char)) {
                frequencies[char] = (frequencies[char] || 0) + 1;
            }
        }
        return frequencies;
    }

    function drawFrequencyChart(frequencies, chartElement, sortByFreq) {
        chartElement.innerHTML = '';
        let sorted;
        if (sortByFreq) {
            sorted = Object.entries(frequencies).sort((a, b) => b[1] - a[1]);
        } else {
            sorted = Object.entries(frequencies).sort((a, b) => b[1] - a[1]);
        }
        if (sorted.length === 0) return;
        const maxFreq = sorted[0][1];
        const chartMaxHeight = 180;
        sorted.forEach(([char, freq]) => {
            const barHeight = maxFreq > 0 ? (freq / maxFreq) * chartMaxHeight : 0;
            const barContainer = document.createElement('div');
            barContainer.className = 'bar-container';
            const bar = document.createElement('div');
            bar.className = 'bar';
            bar.style.height = `${barHeight}px`;
            bar.title = `'${char}': ${freq}`;
            const label = document.createElement('div');
            label.className = 'bar-label';
            label.textContent = char;
            barContainer.appendChild(bar);
            barContainer.appendChild(label);
            chartElement.appendChild(barContainer);
        });
    }

    function createKeyMapGrid() {
        ALPHABET.split('').forEach(char => {
            const entry = document.createElement('div');
            entry.className = 'key-entry';
            const label = document.createElement('label');
            label.textContent = char;
            label.htmlFor = `key-input-${char}`;
            const input = document.createElement('input');
            input.type = 'text';
            input.maxLength = 1;
            input.id = `key-input-${char}`;
            input.dataset.char = char;
            input.addEventListener('input', handleKeyUpdate);
            inputs[char] = input;
            entry.appendChild(label);
            entry.appendChild(input);
            keyMapGridDiv.appendChild(entry);
        });
    }

    function handleKeyUpdate(event) {
        const input = event.target;
        const cipherChar = input.dataset.char;
        const plainGuess = input.value.toUpperCase();
        Object.keys(userKey).forEach(key => {
            if (userKey[key] === plainGuess && key !== cipherChar) {
                inputs[key].value = '';
                delete userKey[key];
            }
        });
        if (plainGuess) {
            userKey[cipherChar] = plainGuess;
        } else {
            delete userKey[cipherChar];
        }
        updateDecryption();
    }

    function updateDecryption() {
        const ciphertext = ciphertextDiv.textContent;
        const decryptedHtml = ciphertext.split('').map(char => {
            if (userKey[char]) {
                return `<span>${userKey[char]}</span>`;
            } else if (ALPHABET.includes(char)) {
                return `<span class="unmapped">_</span>`;
            } else {
                return `<span>${char}</span>`;
            }
        }).join('');
        decryptedTextDiv.innerHTML = decryptedHtml;
    }

    function giveHint(sortedByFreq) {
        for (const [cipherChar] of sortedByFreq) {
            if (!userKey[cipherChar]) {
                const correctPlainChar = reverseSecretKey[cipherChar];
                const input = inputs[cipherChar];
                if (input && !input.value) {
                    input.value = correctPlainChar;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    break;
                }
            }
        }
        if (Object.keys(userKey).length >= sortedByFreq.length) {
            hintButton.disabled = true;
            hintButton.textContent = '完了';
        }
    }

    function showPlaintextFreq() {
        const plaintextFrequencies = calculateFrequencies(PLAINTEXT);
        const chartElement = document.getElementById('plaintext-freq-chart');
        drawFrequencyChart(plaintextFrequencies, chartElement, true);
        plaintextFreqSection.style.display = 'block';
        hint2Button.disabled = true;
    }

    initialize();
});
</script>

</body>
</html>
